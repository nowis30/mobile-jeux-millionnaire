(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[311],{1978:function(e,t,n){Promise.resolve().then(n.bind(n,7257))},7257:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return c}});var l=n(7821),a=n(8078),s=n(4328),i=n(9513),r=n(2044);function c(){let[e,t]=(0,a.useState)(""),[n,c]=(0,a.useState)(""),[o,u]=(0,a.useState)(""),[d,m]=(0,a.useState)([]),[h,x]=(0,a.useState)([]),[v,p]=(0,a.useState)(""),[f,g]=(0,a.useState)(0),[j,y]=(0,a.useState)(null),[N,b]=(0,a.useState)(null),[w,S]=(0,a.useState)(null),[E,C]=(0,a.useState)(null);async function P(e,t){if(!e||!t)return!1;try{let n=await fetch("".concat(i.Sg,"/api/games/").concat(e,"/properties/owner/").concat(t));if(!n.ok)return!1;let l=await n.json(),a=(null==l?void 0:l.ownerNickname)?String(l.ownerNickname).trim():"";return a?S("\uD83D\uDE1C Haha ".concat(a," a d\xe9j\xe0 achet\xe9 !")):S("\uD83D\uDE1C Haha c'est d\xe9j\xe0 achet\xe9 !"),!0}catch(e){return S("\uD83D\uDE1C Haha c'est d\xe9j\xe0 achet\xe9 !"),!0}}(0,a.useEffect)(()=>{if(!w)return;let e=setTimeout(()=>S(null),5e3);return()=>clearTimeout(e)},[w]),(0,a.useEffect)(()=>{(async()=>{try{if(!e){var n;let e=await (0,i.SC)("/api/games"),l=null===(n=e.games)||void 0===n?void 0:n[0];(null==l?void 0:l.id)&&t(l.id)}}catch(e){}})()},[e]),(0,a.useEffect)(()=>{e&&!n&&(async()=>{try{var t;let n=await (0,i.SC)("/api/games/".concat(e,"/me"));c(n.player.id),u(null!==(t=n.player.nickname)&&void 0!==t?t:"")}catch(t){try{let t=await (0,i.SC)("/api/games/".concat(e,"/join"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});c(t.playerId)}catch(e){}}})()},[e,n]);let I=(0,a.useCallback)(async()=>{if(e&&n)try{var t;let l=await fetch("".concat(i.Sg,"/api/games/").concat(e,"/properties/holdings/").concat(n));if(!l.ok)throw Error("Erreur ".concat(l.status));let a=await l.json();m(null!==(t=a.holdings)&&void 0!==t?t:[])}catch(e){console.warn("Chargement holdings \xe9chou\xe9",e)}},[e,n]),A=(0,a.useCallback)(async()=>{if(e)try{var t;let n=await fetch("".concat(i.Sg,"/api/games/").concat(e,"/listings"));if(!n.ok)throw Error("Erreur ".concat(n.status));let l=await n.json();x(null!==(t=l.listings)&&void 0!==t?t:[])}catch(e){console.warn("Chargement listings \xe9chou\xe9",e)}},[e]);(0,a.useEffect)(()=>{if(!e)return;I(),A();let t=setInterval(()=>{A()},3e4);return()=>clearInterval(t)},[e,I,A]),(0,a.useEffect)(()=>{(async()=>{if(e)try{let t=await fetch("".concat(i.Sg,"/api/games/").concat(e,"/economy"));if(t.ok){let e=await t.json();C(e)}}catch(e){}})()},[e]),(0,a.useEffect)(()=>{if(!e)return;let t=(0,s.io)(i.Sg,{query:{gameId:e}});return t.on("event-feed",e=>{"string"==typeof(null==e?void 0:e.type)&&e.type.startsWith("listing:")&&(A(),"listing:accept"===e.type&&I())}),t.emit("join-game",e),()=>{t.disconnect()}},[e,A,I]);let T=(0,a.useMemo)(()=>h.filter(e=>e.sellerId===n),[h,n]),k=(0,a.useMemo)(()=>h.filter(e=>e.sellerId!==n),[h,n]),D=e=>{let t=Number(e||1);return t>=800?"VILLAGE_FUTURISTE":t>=400?"GRATTE_CIEL":t>=50?"TOUR":6===t?"SIXPLEX":3===t?"TRIPLEX":2===t?"DUPLEX":"MAISON"},L=(0,a.useCallback)(async()=>{if(!e||!n||!v||f<=0){y("S\xe9lectionnez un bien et un prix>0");return}try{await (0,i.SC)("/api/games/".concat(e,"/listings"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sellerId:n,holdingId:v,price:f})}),b("Annonce cr\xe9\xe9e"),y(null),p(""),g(0),A()}catch(e){b(null),y(e instanceof Error?e.message:"\xc9chec de cr\xe9ation d'annonce")}},[e,n,v,f,A]),O=(0,a.useCallback)(async t=>{if(e&&n)try{await (0,i.SC)("/api/games/".concat(e,"/listings/").concat(t,"/cancel"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sellerId:n})}),b("Annonce annul\xe9e"),y(null),A(),I()}catch(e){b(null),y(e instanceof Error?e.message:"\xc9chec d'annulation")}},[e,n,A,I]),_=(0,a.useCallback)(async t=>{var l,a,s,r;if(!e||!n)return;let c=h.find(e=>e.id===t),o=(null==c?void 0:c.templateId)||(null==c?void 0:null===(l=c.holding)||void 0===l?void 0:l.templateId)||(null==c?void 0:null===(s=c.holding)||void 0===s?void 0:null===(a=s.template)||void 0===a?void 0:a.id)||(null==c?void 0:null===(r=c.template)||void 0===r?void 0:r.id);try{await (0,i.SC)("/api/games/".concat(e,"/listings/").concat(t,"/accept"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({buyerId:n})}),b("Achat effectu\xe9 via annonce"),y(null),S(null),A(),I()}catch(a){b(null);let t=a instanceof i.MS?a.status:void 0,n=a instanceof Error?a.message:"\xc9chec d'achat";y(n);let l=!1;try{let t=n.match(/(vendu|achete|acheté)[\s\S]*?à\s+['"]?([^'"\n]+)['"]?/i);if(t&&t[2]){let e=t[2].trim();S("\uD83D\uDE1C Haha ".concat(e," a d\xe9j\xe0 vendu !")),l=!0}else/déjà/i.test(n)&&/(vendu|achete|acheté)/i.test(n)&&(l=await P(e,o))}catch(e){}!l&&400===t&&e&&o&&await P(e,o)}},[e,n,h,A,I]);return(0,l.jsxs)("main",{className:"space-y-6",children:[(0,l.jsxs)("section",{children:[(0,l.jsx)("h2",{className:"text-xl font-semibold",children:"Annonces P2P"}),(0,l.jsx)("p",{className:"text-sm text-neutral-400",children:"Publiez vos biens ou achetez ceux des autres joueurs."}),o&&(0,l.jsxs)("p",{className:"text-xs text-neutral-400 mt-1",children:["Connect\xe9 en tant que ",(0,l.jsx)("span",{className:"font-medium",children:o})]}),E&&(0,l.jsxs)("p",{className:"text-xs text-neutral-500 mt-1",children:["Inflation: ",(100*Number(E.inflationAnnual||0)).toFixed(2),"%/an \xb7 Indice cumul\xe9 ",Number(E.inflationIndex||1).toFixed(4),"\xd7"]})]}),(0,l.jsxs)("section",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold",children:"Cr\xe9er une annonce"}),(0,l.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 items-end",children:[(0,l.jsxs)("select",{value:v,onChange:e=>p(e.target.value),className:"px-3 py-2 rounded bg-neutral-900 border border-neutral-700 text-sm",children:[(0,l.jsx)("option",{value:"",children:"S\xe9lectionner un bien"}),d.map(e=>{var t,n;return(0,l.jsxs)("option",{value:e.id,children:[null!==(n=null===(t=e.template)||void 0===t?void 0:t.name)&&void 0!==n?n:e.templateId," - Valeur ",(0,r.l)(e.currentValue)," - Dette ",(0,r.l)(e.mortgageDebt)]},e.id)})]}),(0,l.jsx)("input",{type:"number",value:f,onChange:e=>g(Number(e.target.value)),placeholder:"Prix de vente",className:"px-3 py-2 rounded bg-neutral-900 border border-neutral-700 text-sm"}),(0,l.jsx)("button",{onClick:L,className:"px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500",children:"Publier"})]})]}),(0,l.jsxs)("section",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold",children:"Mes annonces"}),(0,l.jsxs)("div",{className:"grid gap-2",children:[0===T.length&&(0,l.jsx)("p",{className:"text-sm text-neutral-400",children:"Aucune annonce."}),T.map(e=>{var t,n,a,s,i,c,o,u,d,m,h,x,v,p;let f=e.holding,g=null!==(n=null!==(t=null==f?void 0:f.template)&&void 0!==t?t:e.template)&&void 0!==n?n:null,j=(null==g?void 0:g.units)||1,y=(null!==(s=null!==(a=null==f?void 0:f.currentRent)&&void 0!==a?a:null==g?void 0:g.baseRent)&&void 0!==s?s:0)*Number(j||1),N=Number(null!==(i=null==g?void 0:g.maintenance)&&void 0!==i?i:0)||0,b=[null==g?void 0:g.plumbingState,null==g?void 0:g.electricityState,null==g?void 0:g.roofState].map(e=>String(e||"").toLowerCase()),w=1;for(let e of b)e.includes("\xe0 r\xe9nover")||e.includes("a r\xe9nover")||e.includes("r\xe9nover")?w=Math.max(w,1.5):e.includes("moyen")&&(w=Math.max(w,1.25));let S=N*w,E=y-((null!==(c=null==g?void 0:g.taxes)&&void 0!==c?c:0)+(null!==(o=null==g?void 0:g.insurance)&&void 0!==o?o:0)+S)/12-(0,r.P)(null!==(u=null==f?void 0:f.weeklyPayment)&&void 0!==u?u:0),C=(null!==(m=null!==(d=null==f?void 0:f.currentValue)&&void 0!==d?d:null==g?void 0:g.price)&&void 0!==m?m:0)-(null!==(h=null==f?void 0:f.mortgageDebt)&&void 0!==h?h:0),P=D(null==g?void 0:g.units);return(0,l.jsxs)("article",{className:"border border-neutral-800 rounded bg-neutral-900 p-3 grid gap-2",children:[(0,l.jsx)("div",{className:"aspect-video w-full bg-neutral-800 flex items-center justify-center text-neutral-500 rounded",children:(()=>{if("GRATTE_CIEL"===P)return(0,l.jsx)("span",{className:"text-[10px]",children:"Pas de photo"});let e=null==g?void 0:g.imageUrl;return e?(0,l.jsx)("img",{src:String(e),alt:(null==g?void 0:g.name)||"Immeuble",className:"w-full h-full object-cover"}):(0,l.jsx)("span",{className:"text-[10px]",children:"Pas de photo"})})()}),(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"text-sm",children:[(0,l.jsxs)("div",{children:["Prix: ",(0,r.l)(e.price)]}),(0,l.jsxs)("div",{className:"text-xs text-neutral-400",children:["Publi\xe9e: ",new Date(e.createdAt).toLocaleTimeString()]})]}),(0,l.jsx)("button",{onClick:()=>O(e.id),className:"px-3 py-2 rounded bg-neutral-700 hover:bg-neutral-600 text-sm",children:"Annuler"})]}),(0,l.jsxs)("div",{className:"text-xs grid sm:grid-cols-5 gap-2 text-neutral-300",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Valeur:"})," ",(0,r.l)(null!==(v=null!==(x=null==f?void 0:f.currentValue)&&void 0!==x?x:null==g?void 0:g.price)&&void 0!==v?v:0)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Dette:"})," ",(0,r.l)(null!==(p=null==f?void 0:f.mortgageDebt)&&void 0!==p?p:0)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"\xc9quit\xe9:"})," ",(0,l.jsx)("span",{className:C>=0?"text-emerald-400":"text-rose-400",children:(0,r.l)(C)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Loyer/mois:"})," ",(0,r.l)(y)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Cashflow/mois:"})," ",(0,l.jsx)("span",{className:E>=0?"text-emerald-400":"text-rose-400",children:(0,r.l)(E)})]})]})]},e.id)})]})]}),(0,l.jsxs)("section",{className:"space-y-2",children:[(0,l.jsx)("h3",{className:"text-lg font-semibold",children:"Annonces des autres"}),(0,l.jsxs)("div",{className:"grid gap-2",children:[0===k.length&&(0,l.jsx)("p",{className:"text-sm text-neutral-400",children:"Aucune annonce disponible."}),k.map(e=>{var t,n,a,s,i,c,o,u,d,m,h,x,v,p;let f=e.holding,g=null!==(n=null!==(t=null==f?void 0:f.template)&&void 0!==t?t:e.template)&&void 0!==n?n:null,j=(null==g?void 0:g.units)||1,y=(null!==(s=null!==(a=null==f?void 0:f.currentRent)&&void 0!==a?a:null==g?void 0:g.baseRent)&&void 0!==s?s:0)*Number(j||1),N=Number(null!==(i=null==g?void 0:g.maintenance)&&void 0!==i?i:0)||0,b=[null==g?void 0:g.plumbingState,null==g?void 0:g.electricityState,null==g?void 0:g.roofState].map(e=>String(e||"").toLowerCase()),w=1;for(let e of b)e.includes("\xe0 r\xe9nover")||e.includes("a r\xe9nover")||e.includes("r\xe9nover")?w=Math.max(w,1.5):e.includes("moyen")&&(w=Math.max(w,1.25));let S=N*w,E=y-((null!==(c=null==g?void 0:g.taxes)&&void 0!==c?c:0)+(null!==(o=null==g?void 0:g.insurance)&&void 0!==o?o:0)+S)/12-(0,r.P)(null!==(u=null==f?void 0:f.weeklyPayment)&&void 0!==u?u:0),C=(null!==(m=null!==(d=null==f?void 0:f.currentValue)&&void 0!==d?d:null==g?void 0:g.price)&&void 0!==m?m:0)-(null!==(h=null==f?void 0:f.mortgageDebt)&&void 0!==h?h:0),P=D(null==g?void 0:g.units);return(0,l.jsxs)("article",{className:"border border-neutral-800 rounded bg-neutral-900 p-3 grid gap-2",children:[(0,l.jsx)("div",{className:"aspect-video w-full bg-neutral-800 flex items-center justify-center text-neutral-500 rounded",children:(()=>{if("GRATTE_CIEL"===P)return(0,l.jsx)("span",{className:"text-[10px]",children:"Pas de photo"});let e=null==g?void 0:g.imageUrl;return e?(0,l.jsx)("img",{src:String(e),alt:(null==g?void 0:g.name)||"Immeuble",className:"w-full h-full object-cover"}):(0,l.jsx)("span",{className:"text-[10px]",children:"Pas de photo"})})()}),(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"text-sm",children:[(0,l.jsxs)("div",{children:["Prix: ",(0,r.l)(e.price)," ",(null==g?void 0:g.city)?(0,l.jsxs)("span",{className:"text-xs text-neutral-400",children:["— ",g.city]}):null]}),(0,l.jsxs)("div",{className:"text-xs text-neutral-400",children:["Publi\xe9e: ",new Date(e.createdAt).toLocaleTimeString()]})]}),(0,l.jsx)("button",{onClick:()=>_(e.id),className:"px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-sm",children:"Acheter"})]}),(0,l.jsxs)("div",{className:"text-xs grid sm:grid-cols-5 gap-2 text-neutral-300",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Valeur:"})," ",(0,r.l)(null!==(v=null!==(x=null==f?void 0:f.currentValue)&&void 0!==x?x:null==g?void 0:g.price)&&void 0!==v?v:0)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Dette:"})," ",(0,r.l)(null!==(p=null==f?void 0:f.mortgageDebt)&&void 0!==p?p:0)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"\xc9quit\xe9:"})," ",(0,l.jsx)("span",{className:C>=0?"text-emerald-400":"text-rose-400",children:(0,r.l)(C)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Loyer/mois:"})," ",(0,r.l)(y)]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-neutral-400",children:"Cashflow/mois:"})," ",(0,l.jsx)("span",{className:E>=0?"text-emerald-400":"text-rose-400",children:(0,r.l)(E)})]})]})]},e.id)})]})]}),N&&(0,l.jsx)("p",{className:"text-sm text-emerald-400",children:N}),j&&(0,l.jsx)("p",{className:"text-sm text-red-400",children:j}),w&&(0,l.jsx)("div",{className:"fixed top-4 right-4 z-50 bg-neutral-900 border border-amber-500/60 text-amber-200 px-4 py-2 rounded shadow-lg animate-fade-in",children:w})]})}},9513:function(e,t,n){"use strict";n.d(t,{MS:function(){return o},SC:function(){return h},Sg:function(){return c}});var l=n(5050);let a="https://server-jeux-millionnaire.onrender.com",s=!!window.Capacitor,i=/localhost:3000$/.test(window.location.host),r="1"===l.env.NEXT_PUBLIC_FORCE_ABS,c=s||r||!i?a:"";console.log("[API] ABS_BACKEND:",a),console.log("[API] isCapacitor:",s),console.log("[API] isLocalDev:",i),console.log("[API] forceAbs:",r),console.log("[API] API_BASE:",c);class o extends Error{constructor(e,t){super(t),this.name="ApiError",this.status=e,Object.setPrototypeOf(this,o.prototype)}}let u=null,d="HM_TOKEN";async function m(){try{var e;if(u)return u;let t=await fetch("".concat(c,"/api/auth/csrf"),{credentials:"include"});if(!t.ok)return null;let n=await t.json();return u=null!==(e=null==n?void 0:n.csrf)&&void 0!==e?e:null}catch(e){return null}}async function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=(t.method||"GET").toUpperCase(),l={...t.headers};if(console.log("[API] ".concat(n," ").concat(c).concat(e)),["POST","PUT","PATCH","DELETE"].includes(n)){let e=await m();e&&(l["x-csrf-token"]=e)}let a=function(){try{return window.localStorage.getItem(d)}catch(e){return null}}();a&&(l.Authorization="Bearer ".concat(a));let s=function(){try{let e=window.localStorage.getItem("hm-session");if(!e)return null;return JSON.parse(e).playerId||null}catch(e){return null}}();s&&(l["X-Player-ID"]=s);try{let n=await fetch("".concat(c).concat(e),{credentials:"include",...t,headers:l});if(console.log("[API] Response ".concat(n.status," ").concat(n.statusText)),401===n.status)try{if(a){let n=await fetch("".concat(c,"/api/auth/refresh"),{credentials:"include",headers:{Authorization:"Bearer ".concat(a)}});if(n.ok){let a=await n.json().catch(()=>({}));if(null==a?void 0:a.token){try{window.localStorage.setItem(d,a.token)}catch(e){}l.Authorization="Bearer ".concat(a.token)}let s=await fetch("".concat(c).concat(e),{credentials:"include",...t,headers:l});if(!s.ok)throw new o(s.status,s.statusText);if(204===s.status)return;return await s.json()}}}catch(e){}if(!n.ok)try{if((n.headers.get("content-type")||"").includes("application/json")){let e=await n.json(),t=e&&(e.error||e.message)?String(e.error||e.message):"Erreur ".concat(n.status);throw new o(n.status,t)}{let e=(await n.text()||"").trim(),t=e.length?e:n.statusText?"".concat(n.status," ").concat(n.statusText):"Erreur ".concat(n.status);throw new o(n.status,t)}}catch(t){let e=n.statusText?"".concat(n.status," ").concat(n.statusText):"Erreur ".concat(n.status);if(t instanceof o)throw t;throw new o(n.status,e)}if(204===n.status)return;return await n.json()}catch(e){throw console.error("[API] Fetch error:",e),new o(0,"Erreur r\xe9seau: ".concat(e.message||"Failed to fetch"))}}},2044:function(e,t,n){"use strict";function l(e){let t=Number(e);return isFinite(t)?"$".concat(Math.round(t).toLocaleString()):"$0"}function a(e){return 52*Number(e||0)/12}n.d(t,{P:function(){return a},l:function(){return l}})}},function(e){e.O(0,[640,115,205,744],function(){return e(e.s=1978)}),_N_E=e.O()}]);